image: docker:latest

services:
  - docker:dind

before_script:
  - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CONTAINER_REGISTRY
  - apk --no-cache add make

stages:
  - configure
  - build
  - test
  - release

configure:
  stage: configure
  script:
    - cp Makefile.image.variable copy.variable
    - sed -i "/REGISTRY.*:=/c\REGISTRY := $CONTAINER_REGISTRY" Makefile.image.variable
    - sed -i "/NAMESPACE.*:=/c\NAMESPACE := $CI_PROJECT_NAMESPACE" Makefile.image.variable
    - sed -i "/PROJECT.*:=/c\PROJECT := $CI_PROJECT_NAME" Makefile.image.variable
    - sed -i "/PROJECT.*:=/c\PROJECT := $CI_PROJECT_NAME" Makefile.image.variable
    - sed -i "/VCS_REF.*:=/c\VCS_REF := $CI_BUILD_REF" Makefile.metadata.variable
  artifacts:
    paths:
      - "*.variable"
    expire_in: 2 hours

build_baseimage:
  stage: build
  script:
    - make baseimage && make push
  dependencies:
    - configure
  artifacts:
    paths:
      - "*.variable"
    expire_in: 2 hours

build_privileged:
  stage: build
  script:
    - make privileged && make push
  dependencies:
    - configure
  artifacts:
    paths:
      - "*.variable"
    expire_in: 2 hours

test:
  stage: test
  script:
    - make pull
    - make test
  dependencies:
    - build_baseimage
    - build_privileged
  artifacts:
    paths:
      - "*.variable"
      - test/*
    expire_in: 2 hours
    
release:
  stage: release
  script:
    - docker login -u $DOCKER_BUILD_USER -p $DOCKER_BUILD_TOKEN
    - make pull
    - cp copy.variable Makefile.image.variable
    - make push
  dependencies:
    - test